age_sex_plot<-age_sex %>%
filter(cohort=="ONS") %>%
ggplot(aes(x = age_group, y = Percentage, fill = sex,alpha=cohort)) +
geom_bar(stat = "identity",colour="grey3") + geom_bar(data=age_sex[age_sex$cohort=="TPP",], aes(x = age_group, y = n, fill = sex,alpha=cohort),stat = "identity",colour="white") +
coord_flip() +
scale_fill_brewer(palette = "Set1") +scale_alpha_discrete(range=c(0.3,0.7))+
#   scale_y_continuous(breaks = seq(-100, 100, 10),
#                     labels = comma(c(seq(100,0,-10), seq(10,100,10)))) +
theme_bw() + theme(text = element_text(size=8)) + scale_x_discrete(limits = agelevels)
age_sex_plot
age_sex_plot<-age_sex %>%
filter(cohort=="ONS") %>%
ggplot(aes(x = age_group, y = Percentage, fill = sex,alpha=cohort)) +
geom_bar(stat = "identity",colour="grey3") + geom_bar(data=age_sex[age_sex$cohort=="TPP",], aes(x = age_group, y = Percentage, fill = sex,alpha=cohort),stat = "identity",colour="white") +
coord_flip() +
scale_fill_brewer(palette = "Set1") +scale_alpha_discrete(range=c(0.3,0.7))+
#   scale_y_continuous(breaks = seq(-100, 100, 10),
#                     labels = comma(c(seq(100,0,-10), seq(10,100,10)))) +
theme_bw() + theme(text = element_text(size=8)) + scale_x_discrete(limits = agelevels)
age_sex_plot
age_sex_plot<-age_sex %>%
filter(cohort=="ONS") %>%
ggplot(aes(x = age_group, y = Percentage, fill = sex,alpha=cohort)) +
geom_bar(stat = "identity",colour="grey3") + geom_bar(data=age_sex[age_sex$cohort=="TPP",], aes(x = age_group, y = Percentage, fill = sex,alpha=cohort),stat = "identity",colour="white") +
coord_flip() +
scale_fill_brewer(palette = "Set1") +scale_alpha_discrete(range=c(0.3,0.7))+
scale_y_continuous(breaks = seq(-8, 8, 1),
labels = comma(c(seq(-8,0,-1), seq(1,8,1)))) +
theme_bw() + theme(text = element_text(size=8)) + scale_x_discrete(limits = agelevels)
age_sex_plot<-age_sex %>%
filter(cohort=="ONS") %>%
ggplot(aes(x = age_group, y = Percentage, fill = sex,alpha=cohort)) +
geom_bar(stat = "identity",colour="grey3") + geom_bar(data=age_sex[age_sex$cohort=="TPP",], aes(x = age_group, y = Percentage, fill = sex,alpha=cohort),stat = "identity",colour="white") +
coord_flip() +
scale_fill_brewer(palette = "Set1") +scale_alpha_discrete(range=c(0.3,0.7))+
scale_y_continuous(breaks = seq(-8, 8, 1),
labels = comma(c(seq(8,0,-1), seq(1,8,1)))) +
theme_bw() + theme(text = element_text(size=8)) + scale_x_discrete(limits = agelevels)
age_sex_plot
sum(age_sex$Percentage[which(age_sex$sex=="Males" & age_sex$cohort=="ONS")])
sum(age_sex$Percentage[which(age_sex$sex=="Males" & age_sex$cohort=="TPP")])
sum(age_sex$Percentage[which(age_sex$sex=="Females" & age_sex$cohort=="TPP")])
sum(age_sex$Percentage[which(age_sex$sex=="Females" & age_sex$cohort=="ONS")])
age<-  age_sex %>%
group_by(cohort,age_group) %>%
summarise(n = sum(abs(n)))%>%
mutate(Percentage = round((n/sum(n))*100,1)) %>%
ungroup() %>%
#  mutate(age=factor(age,levels=levels(age_sex_tpp$age)))%>%
arrange(cohort,age_group)
################################################################################
# Description: Script to combine TPP & ONS data for deaths, imd, and age
################ RUN LOCALLY ###################################################
#
# input: data/populationbyimdenglandandwales2020.xlsx
#        data/ukpopestimatesmid2020on2021geography.xls
#        data/ONSdeaths2020.csv (downloaded va Nomis: https://www.nomisweb.co.uk/query/construct/components/apicomponent.aspx?menuopt=1611&subcomp=)
#
# output: /data/death_ons.csv.gz
#         /data/imd_ons.csv.gz
#         /data/age_ons_sex.csv.gz
#
# Author: Colm D Andrews
# Date: 14/10/2021
#
################################################################################
library("readxl")
library("tidyverse")
############## IMD
input_imd_ons<-read_excel(here::here("data","populationbyimdenglandandwales2020.xlsx"),sheet="Table 1 - England",skip = 2)
imd_sex_ons<-input_imd_ons %>% rename("sex"=1,"imd"=2) %>% mutate(Total=rowSums(across(!imd & !sex))) %>%
select(sex,imd,Total) %>% drop_na(Total) %>% fill(sex) %>%
mutate(imd = case_when(row_number() %% 2==1~(imd+1)/2,row_number() %% 2==0~imd/2,)) %>%
group_by(sex,imd) %>%
summarise(Total=sum(Total))
imd_ons<-imd_sex_ons %>%
group_by(imd) %>%
summarise(Total=sum(Total)) %>%
mutate(sex="Total") %>% bind_rows(imd_sex_ons) %>%
mutate(cohort="ONS")
write_csv(imd_ons,here::here("data","imd_ons.csv.gz"))  ####add .gz to the end
############### age
age_ons<-read_excel(here::here("data","ukpopestimatesmid2020on2021geography.xls"),sheet ="MYE2 - Persons" ,skip = 7) %>%
filter(Name=="ENGLAND") %>% select(-starts_with("x"),-Code,-Name,-Geography) %>%
select(where(is.numeric) & !starts_with("All")) %>%
rownames_to_column %>%
gather(variable, value, -rowname) %>%
spread(rowname, value) %>%  rename("age"=1,"n"=2) %>%
mutate(cohort="ONS") %>% filter(age!="All ages") %>%
mutate(age=as.numeric(age))  %>%
replace_na(list(age=90))  %>%
mutate(age_group = cut(age, breaks = seq(0,95,5), right = F, labels = c("0-4", "5-9", "10-14", "15-19", "20-24", "25-29", "30-34", "35-39", "40-44", "45-49", "50-54", "55-59", "60-64", "65-69", "70-74", "75-79", "80-84", "85-89", "90+")))
age_ons_males<-read_excel(here::here("data","ukpopestimatesmid2020on2021geography.xls"),sheet ="MYE2 - Males" ,skip = 7) %>%
filter(Name=="ENGLAND") %>%
select(where(is.numeric) & !starts_with("All")) %>%
rownames_to_column %>%
gather(variable, value, -rowname) %>%
spread(rowname, value) %>%  rename("age"=1,"n"=2) %>%
mutate(cohort="ONS") %>%
filter(age!="All ages") %>%
mutate(age=as.numeric(age))  %>%
replace_na(list(age=90))  %>%
mutate(age_group = cut(age, breaks = seq(0,95,5), right = F, labels = c("0-4", "5-9", "10-14", "15-19", "20-24", "25-29", "30-34", "35-39", "40-44", "45-49", "50-54", "55-59", "60-64", "65-69", "70-74", "75-79", "80-84", "85-89", "90+")),
sex="Males")  %>%
group_by(age_group) %>%
mutate(n=sum(n))
age_ons_female<-read_excel(here::here("data","ukpopestimatesmid2020on2021geography.xls"),sheet ="MYE2 - Females" ,skip = 7) %>%
filter(Name=="ENGLAND") %>%
select(where(is.numeric) & !starts_with("All")) %>%
rownames_to_column %>%
gather(variable, value, -rowname) %>%
spread(rowname, value) %>%  rename("age"=1,"n"=2) %>%
mutate(cohort="ONS") %>%
filter(age!="All ages") %>%
mutate(age=as.numeric(age))  %>%
replace_na(list(age=90))  %>%
mutate(age_group = cut(age, breaks = seq(0,95,5), right = F, labels = c("0-4", "5-9", "10-14", "15-19", "20-24", "25-29", "30-34", "35-39", "40-44", "45-49", "50-54", "55-59", "60-64", "65-69", "70-74", "75-79", "80-84", "85-89", "90+")),
sex="Females") %>%
group_by(age_group) %>%
mutate(n=sum(n)) %>%
bind_rows(age_ons_males) %>%
select(-age) %>%
distinct()  -> age_ons_sex
write_csv(age_ons_sex,here::here("data","age_ons_sex.csv.gz"))  ####add .gz to the end
###### death
###### ONS data downloaded va Nomis: https://www.nomisweb.co.uk/query/construct/components/apicomponent.aspx?menuopt=1611&subcomp=
death_ons<-read_csv(here::here("data","ONSdeaths2020.csv"),skip = 11)
ons_total<-read_csv(here::here("data","ONSdeaths2020.csv"),skip = 10,n_max = 1) %>%
rename("x1"=1,"Total"=2) %>% select(Total)
### reformat ons data
death_ons<-death_ons %>% rename("cod"=1,"Count"=2) %>% bind_cols(ons_total) %>%
mutate(Cause_of_Death=case_when(str_sub(cod,1,3)=="U07"~"COVID-19",
str_sub(cod,4,4)=="-"~str_sub(cod,9),
str_sub(cod,4,4)==" "~str_sub(cod,5))) %>%
mutate(Percentage = round((Count/Total),4)*100,Cohort="ONS") %>%
select(-cod,-Total)
write_csv(death_ons,here::here("data","death_ons.csv.gz"))  ####add .gz to the end
################################################################################
# Description: Script to combine TPP & ONS data for deaths, imd, and age
#
# input: /output/cohorts/input.csv.gz
#        /data/death_ons.csv.gz
#        /data/imd_ons.csv.gz
#        /data/age_ons_sex.csv.gz
#
# output: /output/tables/age_sex_count.csv.gz
#         /output/tables/age_count.csv.gz
#         /output/tables/death_count.csv.gz
#         /output/tables/imd_count.csv.gz
#
# Author: Colm D Andrews
# Date: 08/10/2021
#
################################################################################
## Redactor code (W.Hulme)
redactor <- function(n, threshold=6,e_overwrite=NA_integer_){
# given a vector of frequencies, this returns a boolean vector that is TRUE if
# a) the frequency is <= the redaction threshold and
# b) if the sum of redacted frequencies in a) is still <= the threshold, then the
# next largest frequency is also redacted
n <- as.integer(n)
leq_threshold <- dplyr::between(n, 1, threshold)
n_sum <- sum(n)
# redact if n is less than or equal to redaction threshold
redact <- leq_threshold
# also redact next smallest n if sum of redacted n is still less than or equal to threshold
if((sum(n*leq_threshold) <= threshold) & any(leq_threshold)){
redact[which.min(dplyr::if_else(leq_threshold, n_sum+1L, n))] = TRUE
}
n_redacted <- if_else(redact, e_overwrite, n)
}
print("redactor function")
## import libraries
library('tidyverse')
library('sf')
fs::dir_create(here::here("output", "tables"))
# # import data
df_input <- read_csv(here::here("output", "cohorts","input.csv.gz")) %>%
mutate(sex = case_when(sex=="F"~"Females",sex=="M"~"Males",sex=="I"~"I",sex=="U"~"Unknown"))
###################################### deaths
##import ONS death data
death_ons<-read_csv(here::here("data","death_ons.csv.gz"))
TPP_death <- df_input %>%
mutate(
total=sum(died_any),
# extract relevant parts of the ICD-10 codes to classify deaths
cause_chapter = str_sub(died_cause_ons,1,1),
cause =str_sub(died_cause_ons,1,3),
# create specific causes of death to match K Baskharan's analysis
# assumes COVID-19 if more than one primary/underlying
Broad_Cause_of_Death = case_when(
cause_chapter == "C" ~ "Cancer",
cause_chapter == "I" ~ "Cardiovascular Disease",
cause_chapter == "J" ~ "Respiratory Disease",
# dementia codes should be F01, F02, F03 and G30
cause >= "F0" & cause_chapter <"F4" ~ 'Dementia',
cause == "G30" ~ 'Dementia',
died_ons_covid_flag_any == 1 ~ "COVID-19",
TRUE ~ "Other"),
Broad_Cause_of_Death = factor(Broad_Cause_of_Death, levels = c("Respiratory Disease", "Dementia", "Cardiovascular Disease", "Cancer", "Other", "COVID-19")),
Cause_of_Death = case_when(
cause == "C15" ~ "Malignant neoplasm of oesophagus",
cause == "C16" ~ "Malignant neoplasm of stomach",
cause == "C18" ~ "Malignant neoplasm of colon",
cause >= "C19" & cause <="C21" ~ "Malignant neoplasm of rectosigmoid junction, rectum and anus",
cause == "C25" ~ "Malignant neoplasm of pancreas",
cause >= "C33" & cause <="C34" ~ "Malignant neoplasm of trachea, bronchus and lung",
cause == "C43" ~ "Malignant melanoma of the skin",
cause == "C44" ~ "Other malignant neoplasms of skin",
cause == "C50" ~ "Malignant neoplasm of breast",
cause == "C53" ~ "Malignant neoplasm of cervix uteri",
cause == "C61" ~ "Malignant neoplasm of prostate",
cause == "C67" ~ "Malignant neoplasm of bladder",
cause >= "C91" & cause <="C95" ~ "Leukaemia",
cause >= "E10" & cause <="E14" ~ "Diabetes mellitus",
cause >= "F01" & cause <="F03" ~ "Dementias",
cause == "G30" ~ "Alzheimer disease",
cause >= "I20" & cause <="I25" ~ "Ischaemic heart diseases",
cause >= "I60" & cause <="I69" ~ "Cerebrovascular diseases",
cause >= "J12" & cause <="J18" ~ "Pneumonia",
cause >= "J40" & cause <="J44" ~ "Bronchitis, emphysema and other chronic obstructive pulmonary disease",
cause >= "K25" & cause <="K27" ~ "Gastric and duodenal ulcer",
cause >= "K70" & cause <="K77" ~ "Diseases of liver",
cause >= "V01" & cause <="V89" ~ "Land transport accidents",
cause >= "X60" & cause <="X84" ~ "Intentional self-harm",
cause >= "Y10" & cause <="Y34" ~ "Event of undetermined intent",
cause == "U07" |cause == "U10.9" ~ "COVID-19")) %>%
drop_na(Cause_of_Death)
###### combine TPP and ONS data
deaths <- TPP_death %>%
# calculate frequency of each code
group_by(Cause_of_Death) %>%
summarise(Count = n(),total=mean(total)) %>%
mutate(Percentage = round((Count/total)*100,4),Cohort="TPP")  %>%
select(-total) %>%
bind_rows(death_ons)
redacted_deaths <- deaths %>% mutate_at(vars(Count),redactor) %>%
mutate(Percentage=case_when(!is.na(Count)~Percentage))
write_csv(redacted_deaths,here::here("output", "tables","death_count.csv"))  ####add .gz to the end
############################# imd ###################################################
imd_ons<-read_csv(here::here("data","imd_ons.csv.gz"))
imd_sex<-df_input %>%
group_by(imd,sex) %>% summarise(Total = n())
imd<-imd_sex%>%
group_by(imd) %>%
summarise(Total=sum(Total)) %>%
mutate(sex="Total") %>% bind_rows(imd_sex) %>%
mutate(cohort="TPP")  %>%
bind_rows(imd_ons)%>%
group_by(sex,cohort) %>%
mutate(Percentage = round((Total/sum(Total))*100,4)) %>%
ungroup() %>% arrange(cohort,sex,imd) %>%
mutate(imd = case_when(imd==1~"1: Most deprived",imd==2~"2",imd==3~"3",imd==4~"4",imd==0~"Unknown",imd==5~"5: Least deprived"))
redacted_imd <- imd %>% mutate_at(vars(Total),redactor) %>%
mutate(Percentage=case_when(!is.na(Total)~Percentage))
write_csv(redacted_imd,here::here("output", "tables","imd_count.csv"))  ####add .gz to the end
############################################## age
age_ons_sex<-read_csv(here::here("data","age_ons_sex.csv.gz"))
age_sex_tpp <- df_input %>%
filter(age>=0)  %>%
mutate(age=(case_when(age>90~90,TRUE~age)),
age_group = cut(age, breaks = seq(0,95,5), right = F, labels = c("0-4", "5-9", "10-14", "15-19", "20-24", "25-29", "30-34", "35-39", "40-44", "45-49", "50-54", "55-59", "60-64", "65-69", "70-74", "75-79", "80-84", "85-89", "90+"))) %>%
group_by(age_group,sex) %>% summarise(n = n()) %>%
mutate(cohort="TPP")
age_sex<- age_sex_tpp %>%
bind_rows(age_ons_sex)%>%
group_by(sex,cohort) %>%
mutate(Percentage = round((n/sum(n))*100,1)) %>%
arrange(cohort,age_group)
agelevels<-levels(age_sex_tpp$age)
saveRDS(agelevels, here::here("output", "tables","levels.RData"))
age<-  age_sex %>%
group_by(cohort,age_group) %>%
summarise(n = sum(abs(n)))%>%
mutate(Percentage = round((n/sum(n))*100,1)) %>%
ungroup() %>%
#  mutate(age=factor(age,levels=levels(age_sex_tpp$age)))%>%
arrange(cohort,age_group)
redacted_age <- age %>% mutate_at(vars(n),redactor) %>%
mutate(Percentage=case_when(!is.na(n)~Percentage))
write_csv(redacted_age,here::here("output", "tables","age_count.csv"))
redacted_age_sex <- age_sex %>% mutate_at(vars(n),redactor) %>%
mutate(Percentage=case_when(!is.na(n)~Percentage))
write_csv(redacted_age_sex,here::here("output", "tables","age_sex_count.csv"))  ####add .gz to the en
################################################ age
age_sex<-read_csv(here::here("output", "tables","age_sex_count.csv"),
col_types = cols(age =  readr::col_factor(levels=agelevels)))
age_sex<- age_sex %>%
mutate(sex=case_when(sex=="Females"~"Females",sex=="Males"~"Males"),
Percentage=case_when( sex=="Females"~Percentage,sex=="Males"~(-1*Percentage))) %>%
drop_na()
age_sex_plot<-age_sex %>%
filter(cohort=="ONS") %>%
ggplot(aes(x = age_group, y = Percentage, fill = sex,alpha=cohort)) +
geom_bar(stat = "identity",colour="grey3") + geom_bar(data=age_sex[age_sex$cohort=="TPP",], aes(x = age_group, y = Percentage, fill = sex,alpha=cohort),stat = "identity",colour="white") +
coord_flip() +
scale_fill_brewer(palette = "Set1") +scale_alpha_discrete(range=c(0.3,0.7))+
scale_y_continuous(breaks = seq(-8, 8, 1),
labels = comma(c(seq(8,0,-1), seq(1,8,1)))) +
theme_bw() + theme(text = element_text(size=8)) + scale_x_discrete(limits = agelevels)
ggsave(filename=here::here("output", "plots","age_sex_count.svg"),age_sex_plot,width = 30, height = 30, units = "cm")
age_sex_plot
sum(age_sex$Percentage[which(age_sex$sex=="Females" & age_sex$cohort=="ONS")])
sum(age_sex$Percentage[which(age_sex$sex=="Females" & age_sex$cohort=="TPP")])
sum(age_sex$Percentage[which(age_sex$sex=="Males" & age_sex$cohort=="ONS")])
sum(age_sex$Percentage[which(age_sex$sex=="Males" & age_sex$cohort=="TPP")])
###### sex
sex_plot<-age_sex %>%
select(sex, cohort,n) %>%
group_by(cohort,sex) %>%
summarise(count = sum(abs(n))) %>%
mutate(Percentage = round((count/sum(count)),4)*100)  %>%
ggplot(aes(x=sex, y=Percentage, fill=cohort)) +geom_bar(stat = "identity",position = "dodge") +
theme_classic() + theme(axis.text.x = element_text(size=8,angle = 90,hjust=0.95,vjust=0.2)) +
xlab("") + ylab(" % of cohort")
sex_plot
age<-read_csv(here::here("output", "tables","age_count.csv"),col_types = cols(
age =  readr::col_factor(levels=agelevels)))
age_plot <-age %>%
ggplot(aes(x=age, y=Percentage, fill=cohort)) +geom_bar(stat = "identity",position = "dodge") +
theme_classic() + theme(axis.text.x = element_text(size=8,angle = 90,hjust=0.95,vjust=0.2)) +
xlab("") + ylab(" % of cohort") +
scale_x_discrete(limits = agelevels)
age_plot
age_plot <-age %>%
ggplot(aes(x=age_group, y=Percentage, fill=cohort)) +geom_bar(stat = "identity",position = "dodge") +
theme_classic() + theme(axis.text.x = element_text(size=8,angle = 90,hjust=0.95,vjust=0.2)) +
xlab("") + ylab(" % of cohort") +
scale_x_discrete(limits = agelevels)
age_plot
age_sex_plot<-age_sex %>%
filter(cohort=="ONS") %>%
ggplot(aes(x = age_group, y = Percentage, fill = sex,alpha=cohort)) +
geom_bar(stat = "identity",colour="grey3") + geom_bar(data=age_sex[age_sex$cohort=="TPP",], aes(x = age_group, y = Percentage, fill = sex,alpha=cohort),stat = "identity",colour="white") +
coord_flip() +
scale_fill_brewer(palette = "Set1") +scale_alpha_discrete(range=c(0.3,0.7))+
scale_y_continuous(breaks = seq(-8, 8, 1),
labels = comma(c(seq(8,0,-1), seq(1,8,1)))) +
theme_bw() + theme(text = element_text(size=8)) + scale_x_discrete(limits = agelevels) +
xlab("") + ylab(" % of cohort") +
ggsave(filename=here::here("output", "plots","age_sex_count.svg"),age_sex_plot,width = 30, height = 30, units = "cm")
age_sex_plot<-age_sex %>%
filter(cohort=="ONS") %>%
ggplot(aes(x = age_group, y = Percentage, fill = sex,alpha=cohort)) +
geom_bar(stat = "identity",colour="grey3") + geom_bar(data=age_sex[age_sex$cohort=="TPP",], aes(x = age_group, y = Percentage, fill = sex,alpha=cohort),stat = "identity",colour="white") +
coord_flip() +
scale_fill_brewer(palette = "Set1") +scale_alpha_discrete(range=c(0.3,0.7))+
scale_y_continuous(breaks = seq(-8, 8, 1),
labels = comma(c(seq(8,0,-1), seq(1,8,1)))) +
theme_bw() + theme(text = element_text(size=8)) + scale_x_discrete(limits = agelevels) +
xlab("") + ylab(" % of cohort") +
ggsave(filename=here::here("output", "plots","age_sex_count.svg"),age_sex_plot,width = 30, height = 30, units = "cm")
age_sex_plot<-age_sex %>%
filter(cohort=="ONS") %>%
ggplot(aes(x = age_group, y = Percentage, fill = sex,alpha=cohort)) +
geom_bar(stat = "identity",colour="grey3") + geom_bar(data=age_sex[age_sex$cohort=="TPP",], aes(x = age_group, y = Percentage, fill = sex,alpha=cohort),stat = "identity",colour="white") +
coord_flip() +
scale_fill_brewer(palette = "Set1") +scale_alpha_discrete(range=c(0.3,0.7))+
scale_y_continuous(breaks = seq(-8, 8, 1),
labels = comma(c(seq(8,0,-1), seq(1,8,1)))) +
theme_bw() + theme(text = element_text(size=8)) + scale_x_discrete(limits = agelevels) +
xlab("") + ylab(" % of cohort")
age_sex_plot
age_plot
################################################################################
# Description: Script to combine TPP & ONS data for deaths, imd, and age
#
# input: /output/cohorts/input.csv.gz
#        /data/death_ons.csv.gz
#        /data/imd_ons.csv.gz
#        /data/age_ons_sex.csv.gz
#
# output: /output/tables/age_sex_count.csv.gz
#         /output/tables/age_count.csv.gz
#         /output/tables/death_count.csv.gz
#         /output/tables/imd_count.csv.gz
#
# Author: Colm D Andrews
# Date: 08/10/2021
#
################################################################################
## Redactor code (W.Hulme)
redactor <- function(n, threshold=6,e_overwrite=NA_integer_){
# given a vector of frequencies, this returns a boolean vector that is TRUE if
# a) the frequency is <= the redaction threshold and
# b) if the sum of redacted frequencies in a) is still <= the threshold, then the
# next largest frequency is also redacted
n <- as.integer(n)
leq_threshold <- dplyr::between(n, 1, threshold)
n_sum <- sum(n)
# redact if n is less than or equal to redaction threshold
redact <- leq_threshold
# also redact next smallest n if sum of redacted n is still less than or equal to threshold
if((sum(n*leq_threshold) <= threshold) & any(leq_threshold)){
redact[which.min(dplyr::if_else(leq_threshold, n_sum+1L, n))] = TRUE
}
n_redacted <- if_else(redact, e_overwrite, n)
}
print("redactor function")
## import libraries
library('tidyverse')
library('sf')
fs::dir_create(here::here("output", "tables"))
# # import data
df_input <- read_csv(here::here("output", "cohorts","input.csv.gz")) %>%
mutate(sex = case_when(sex=="F"~"Females",sex=="M"~"Males",sex=="I"~"I",sex=="U"~"Unknown"))
###################################### deaths
##import ONS death data
death_ons<-read_csv(here::here("data","death_ons.csv.gz"))
TPP_death <- df_input %>%
mutate(
total=sum(died_any),
# extract relevant parts of the ICD-10 codes to classify deaths
cause_chapter = str_sub(died_cause_ons,1,1),
cause =str_sub(died_cause_ons,1,3),
# create specific causes of death to match K Baskharan's analysis
# assumes COVID-19 if more than one primary/underlying
Broad_Cause_of_Death = case_when(
cause_chapter == "C" ~ "Cancer",
cause_chapter == "I" ~ "Cardiovascular Disease",
cause_chapter == "J" ~ "Respiratory Disease",
# dementia codes should be F01, F02, F03 and G30
cause >= "F0" & cause_chapter <"F4" ~ 'Dementia',
cause == "G30" ~ 'Dementia',
died_ons_covid_flag_any == 1 ~ "COVID-19",
TRUE ~ "Other"),
Broad_Cause_of_Death = factor(Broad_Cause_of_Death, levels = c("Respiratory Disease", "Dementia", "Cardiovascular Disease", "Cancer", "Other", "COVID-19")),
Cause_of_Death = case_when(
cause == "C15" ~ "Malignant neoplasm of oesophagus",
cause == "C16" ~ "Malignant neoplasm of stomach",
cause == "C18" ~ "Malignant neoplasm of colon",
cause >= "C19" & cause <="C21" ~ "Malignant neoplasm of rectosigmoid junction, rectum and anus",
cause == "C25" ~ "Malignant neoplasm of pancreas",
cause >= "C33" & cause <="C34" ~ "Malignant neoplasm of trachea, bronchus and lung",
cause == "C43" ~ "Malignant melanoma of the skin",
cause == "C44" ~ "Other malignant neoplasms of skin",
cause == "C50" ~ "Malignant neoplasm of breast",
cause == "C53" ~ "Malignant neoplasm of cervix uteri",
cause == "C61" ~ "Malignant neoplasm of prostate",
cause == "C67" ~ "Malignant neoplasm of bladder",
cause >= "C91" & cause <="C95" ~ "Leukaemia",
cause >= "E10" & cause <="E14" ~ "Diabetes mellitus",
cause >= "F01" & cause <="F03" ~ "Dementias",
cause == "G30" ~ "Alzheimer disease",
cause >= "I20" & cause <="I25" ~ "Ischaemic heart diseases",
cause >= "I60" & cause <="I69" ~ "Cerebrovascular diseases",
cause >= "J12" & cause <="J18" ~ "Pneumonia",
cause >= "J40" & cause <="J44" ~ "Bronchitis, emphysema and other chronic obstructive pulmonary disease",
cause >= "K25" & cause <="K27" ~ "Gastric and duodenal ulcer",
cause >= "K70" & cause <="K77" ~ "Diseases of liver",
cause >= "V01" & cause <="V89" ~ "Land transport accidents",
cause >= "X60" & cause <="X84" ~ "Intentional self-harm",
cause >= "Y10" & cause <="Y34" ~ "Event of undetermined intent",
cause == "U07" |cause == "U10.9" ~ "COVID-19")) %>%
drop_na(Cause_of_Death)
###### combine TPP and ONS data
deaths <- TPP_death %>%
# calculate frequency of each code
group_by(Cause_of_Death) %>%
summarise(Count = n(),total=mean(total)) %>%
mutate(Percentage = round((Count/total)*100,4),Cohort="TPP")  %>%
select(-total) %>%
bind_rows(death_ons)
redacted_deaths <- deaths %>% mutate_at(vars(Count),redactor) %>%
mutate(Percentage=case_when(!is.na(Count)~Percentage))
write_csv(redacted_deaths,here::here("output", "tables","death_count.csv"))  ####add .gz to the end
############################# imd ###################################################
imd_ons<-read_csv(here::here("data","imd_ons.csv.gz"))
imd_sex<-df_input %>%
group_by(imd,sex) %>% summarise(Total = n())
imd<-imd_sex%>%
group_by(imd) %>%
summarise(Total=sum(Total)) %>%
mutate(sex="Total") %>% bind_rows(imd_sex) %>%
mutate(cohort="TPP")  %>%
bind_rows(imd_ons)%>%
group_by(sex,cohort) %>%
mutate(Percentage = round((Total/sum(Total))*100,4)) %>%
ungroup() %>% arrange(cohort,sex,imd) %>%
mutate(imd = case_when(imd==1~"1: Most deprived",imd==2~"2",imd==3~"3",imd==4~"4",imd==0~"Unknown",imd==5~"5: Least deprived"))
redacted_imd <- imd %>% mutate_at(vars(Total),redactor) %>%
mutate(Percentage=case_when(!is.na(Total)~Percentage))
write_csv(redacted_imd,here::here("output", "tables","imd_count.csv"))  ####add .gz to the end
############################################## age
age_ons_sex<-read_csv(here::here("data","age_ons_sex.csv.gz"))
age_sex_tpp <- df_input %>%
filter(age>=0)  %>%
mutate(age=(case_when(age>90~90,TRUE~age)),
age_group = cut(age, breaks = seq(0,95,5), right = F, labels = c("0-4", "5-9", "10-14", "15-19", "20-24", "25-29", "30-34", "35-39", "40-44", "45-49", "50-54", "55-59", "60-64", "65-69", "70-74", "75-79", "80-84", "85-89", "90+"))) %>%
group_by(age_group,sex) %>% summarise(n = n()) %>%
mutate(cohort="TPP")
age_sex<- age_sex_tpp %>%
bind_rows(age_ons_sex)%>%
group_by(sex,cohort) %>%
mutate(Percentage = round((n/sum(n))*100,1)) %>%
arrange(cohort,age_group)
agelevels<-levels(age_sex_tpp$age)
saveRDS(agelevels, here::here("output", "tables","levels.RData"))
age<-  age_sex %>%
group_by(cohort,age_group) %>%
summarise(n = sum(abs(n)))%>%
mutate(Percentage = round((n/sum(n))*100,1)) %>%
ungroup() %>%
#  mutate(age=factor(age,levels=levels(age_sex_tpp$age)))%>%
arrange(cohort,age_group)
redacted_age <- age %>% mutate_at(vars(n),redactor) %>%
mutate(Percentage=case_when(!is.na(n)~Percentage))
write_csv(redacted_age,here::here("output", "tables","age_count.csv"))
redacted_age_sex <- age_sex %>% mutate_at(vars(n),redactor) %>%
mutate(Percentage=case_when(!is.na(n)~Percentage))
write_csv(redacted_age_sex,here::here("output", "tables","age_sex_count.csv"))  ####add .gz to the en
agelevels<-c("0-4", "5-9", "10-14", "15-19", "20-24", "25-29", "30-34", "35-39", "40-44", "45-49", "50-54", "55-59", "60-64", "65-69", "70-74", "75-79", "80-84", "85-89", "90+")
